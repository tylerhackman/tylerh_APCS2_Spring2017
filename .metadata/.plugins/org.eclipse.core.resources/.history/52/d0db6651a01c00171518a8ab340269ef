package textExcel;

import java.util.Arrays;

public class FormulaCell extends RealCell {
	
	Cell [][] newSpreadsheet = Spreadsheet.spreadsheet;
	//Constructs a new formula cell
	public FormulaCell(String userInput) {
		super(userInput);
	}
	
	//Returns the value of the evaluated formula truncated to ten spaces
	public String abbreviatedCellText() {
		String cellContents = "" + this.getDoubleValue();
		String returnString = cellContents;
		if(cellContents.length() > 10) {
			return(cellContents.substring(0, 10));
		}
		else {
			for(int i = 0; i < 10 - cellContents.length(); i++) {
				returnString += " ";
			}
			return returnString;
		}
	}
	
	//Evaluates the formula of a formula cell
	public double getDoubleValue() {
		String [] arr = getUserInput().substring(2, getUserInput().length()-2).split(" ");
		double value = 0.0;	
		double value2 = 0.0;
		if(arr[0].equals("SUM") || arr[0].equals("AVG")) {
			return 0.0;
		}
		else {
			if(isNumeric(arr[0].substring(0, 1))) {
				value = Double.valueOf(arr[0]);
			}
			else {
				SpreadsheetLocation location = new SpreadsheetLocation(arr[0]);
				value = Double.valueOf(newSpreadsheet[location.getRow() + 1][location.getCol() + 1].fullCellText());
			}
			for(int i = 0; i < arr.length - 1; i += 2) {
				if(isNumeric(arr[i+2].substring(0, 1))) {
					value2 = Double.valueOf(arr[i+2]);
				}
				else {
					SpreadsheetLocation location = new SpreadsheetLocation(arr[i+2]);
					value2 = Double.valueOf(newSpreadsheet[location.getRow() + 1][location.getCol() + 1].fullCellText());
				}
					if(arr[i+1].equals("+")) {
						value += value2;
					}
					else {
						if(arr[i+1].equals("-")) {
							value -= value2;
						}
						else {
							if(arr[i+1].equals("*")) {
								value *= value2;
							}
							else {
								if(arr[i+1].equals("/")) {
									value /= value2;
								}
							}
						}	
					}
			}
		}
		return value;
	}
	//Tests if a string is numeric (only containing numbers, a '.', or a '-')
		public boolean isNumeric(String input) {
			String testString;
			boolean returnValue = true;
			if(input.charAt(0) == '-') {			
				testString = input.substring(1);			
			}
			else {
				testString = input;	
			}
		
			for(int i = 0; i < testString.length(); i ++) {
				if(testString.charAt(i) != '.') {
					if(!Character.isDigit(testString.charAt(i))) {
						return !returnValue;
					}
				}
			}
				return returnValue;
		}
}
